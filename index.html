<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Toronto Recreation Finder</title>
    
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .filters-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
            width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .filters-panel h3 {
            margin-bottom: 20px;
            font-size: 20px;
            color: #1e293b;
        }
        
        .filter-group {
            margin-bottom: 16px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
            color: #334155;
        }
        
        .filter-group select,
        .filter-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .filter-group select:focus,
        .filter-group input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
            margin-top: 8px;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn-link {
            background: transparent;
            color: #3b82f6;
            text-decoration: underline;
            padding: 8px;
        }
        
        #status {
            margin-top: 16px;
            padding: 12px;
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 6px;
            font-size: 13px;
            color: #0c4a6e;
        }
        
        .details-sidebar {
            position: fixed;
            top: 0;
            right: -550px;
            width: 550px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 12px rgba(0,0,0,0.15);
            z-index: 20;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .details-sidebar.open {
            right: 0;
        }
        
        .sidebar-resizer {
            position: absolute;
            left: 0;
            top: 0;
            width: 10px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            z-index: 30;
        }
        
        .sidebar-resizer:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .sidebar-resizer:active {
            background: #3b82f6;
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .sidebar-header h2 {
            margin-bottom: 8px;
            font-size: 22px;
        }
        
        .sidebar-header .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }
        
        .sidebar-header .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .sidebar-content {
            padding: 20px;
        }
        
        .info-section {
            margin-bottom: 24px;
        }
        
        .info-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .info-row {
            display: flex;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .info-label {
            font-weight: 600;
            color: #64748b;
            min-width: 120px;
        }
        
        .info-value {
            color: #1e293b;
            flex: 1;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-green {
            background: #dcfce7;
            color: #166534;
        }
        
        .dropdown-toggle {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .dropdown-toggle:hover {
            background: #e2e8f0;
        }
        
        .dropdown-toggle.open {
            background: #dbeafe;
        }
        
        .dropdown-arrow {
            transition: transform 0.2s;
            font-size: 12px;
        }
        
        .dropdown-arrow.open {
            transform: rotate(180deg);
        }
        
        .program-types-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            margin-bottom: 16px;
            max-height: 100px;
            overflow-y: auto;
            resize: vertical;
            min-height: 100px;
        }
        
        .program-types-container.open {
            display: flex;
        }
        
        .program-type-badge {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .program-type-badge:hover {
            transform: scale(1.05);
        }
        
        .program-type-badge.active {
            border-color: #1e293b;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #1e293b;
        }
        
        .program-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .program-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #3b82f6;
        }
        
        .program-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .program-details {
            font-size: 13px;
            color: #64748b;
        }
        
        .external-link {
            display: inline-block;
            margin-top: 16px;
            padding: 12px 20px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .external-link:hover {
            background: #2563eb;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 5;
        }
        
        .legend-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
            color: #1e293b;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .legend-item:hover {
            background: #f1f5f9;
        }
        
        .legend-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .legend-text {
            font-size: 13px;
            color: #475569;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .empty-state {
            padding: 40px;
            text-align: center;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="filters-panel">
        <h3>Toronto Recreation Finder</h3>
        
        <div class="filter-group">
            <label for="activity-filter">Activity / Program</label>
            <select id="activity-filter">
                <option value="">All Activities</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="district-filter">District</label>
            <select id="district-filter">
                <option value="">All Districts</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="weekday-filter">Day of Week</label>
            <select id="weekday-filter">
                <option value="">Any Day</option>
                <option value="0">Monday</option>
                <option value="1">Tuesday</option>
                <option value="2">Wednesday</option>
                <option value="3">Thursday</option>
                <option value="4">Friday</option>
                <option value="5">Saturday</option>
                <option value="6">Sunday</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="age-filter">Age</label>
            <select id="age-filter">
                <option value="">All Ages</option>
                <option value="young">Under 12</option>
                <option value="teen">13-18</option>
                <option value="adult">19-65</option>
                <option value="senior">65+</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="facility-filter">Facility Type</label>
            <select id="facility-filter">
                <option value="">All Types</option>
            </select>
        </div>
        
        <div class="filter-group">
            <button class="btn btn-primary" onclick="applyFilters()">Search</button>
            <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
        </div>
        
        <div class="filter-group">
            <button class="btn btn-link" onclick="findNearMe()">Find Near Me</button>
        </div>
        
        <div id="status">
            Loading map...
        </div>
    </div>
    
    <div class="details-sidebar" id="detailsSidebar">
        <div class="sidebar-resizer" id="sidebarResizer"></div>
        <div class="sidebar-header">
            <button class="close-btn" onclick="closeSidebar()">×</button>
            <h2 id="sidebarTitle">Centre Details</h2>
            <p id="sidebarSubtitle" style="opacity: 0.9; font-size: 14px;"></p>
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <div class="empty-state">Select a centre on the map to view details</div>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-title">Map Layers</div>
        <label class="legend-item">
            <input type="checkbox" id="toggle-centres" checked onchange="toggleLayer('centres')">
            <div class="legend-icon" style="background: #3b82f6;"></div>
            <span class="legend-text">Recreation Centres</span>
        </label>
        <label class="legend-item">
            <input type="checkbox" id="toggle-wards" checked onchange="toggleLayer('wards')">
            <div class="legend-icon" style="border: 2px solid #1e293b; background: transparent;"></div>
            <span class="legend-text">Ward Boundaries</span>
        </label>
    </div>
    
    <div class="loading" id="loading">Loading...</div>

    <script>
        const API_URL = 'http://localhost:8000';
        let map;
        let userLocation = null;
        let currentCentreId = null;
        let allPrograms = { dropin: [], registered: [] };
        
        map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm-tiles': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm-tiles',
                    type: 'raster',
                    source: 'osm-tiles',
                    minzoom: 0,
                    maxzoom: 19
                }]
            },
            center: [-79.3832, 43.6532],
            zoom: 11
        });
        
        map.on('load', async () => {
            console.log('Map loaded');
            await Promise.all([
                loadWards(),
                loadFilterOptions(),
                loadCentres()
            ]);
            document.getElementById('status').innerHTML = 'Map loaded!<br><small>Click markers for details</small>';
            initSidebarResizer();
        });
        
        async function loadWards() {
            try {
                const response = await fetch(`${API_URL}/api/wards/geojson`);
                const data = await response.json();
                
                map.addSource('wards', { type: 'geojson', data: data });
                
                // Add ward layers BEFORE adding centres layer
                map.addLayer({
                    id: 'wards-fill',
                    type: 'fill',
                    source: 'wards',
                    paint: { 
                        'fill-color': '#94a3b8', 
                        'fill-opacity': 0.15 
                    }
                });
                
                map.addLayer({
                    id: 'wards-outline',
                    type: 'line',
                    source: 'wards',
                    paint: { 
                        'line-color': '#1e293b', 
                        'line-width': 2.5, 
                        'line-opacity': 0.9 
                    }
                });
                
                console.log('Wards loaded successfully');
            } catch (error) {
                console.error('Error loading wards:', error);
            }
        }
        
        async function loadFilterOptions() {
            try {
                const [activitiesRes, districtsRes, typesRes] = await Promise.all([
                    fetch(`${API_URL}/api/activities?limit=100`),
                    fetch(`${API_URL}/api/districts`),
                    fetch(`${API_URL}/api/facility-types`)
                ]);
                
                const [activities, districts, types] = await Promise.all([
                    activitiesRes.json(),
                    districtsRes.json(),
                    typesRes.json()
                ]);
                
                const activitySelect = document.getElementById('activity-filter');
                activitySelect.innerHTML = '<option value="">All Activities</option>';
                activities.forEach(act => {
                    const option = document.createElement('option');
                    option.value = act.activity;
                    option.textContent = `${act.activity} (${act.count})`;
                    activitySelect.appendChild(option);
                });
                
                const districtSelect = document.getElementById('district-filter');
                districtSelect.innerHTML = '<option value="">All Districts</option>';
                districts.forEach(dist => {
                    const option = document.createElement('option');
                    option.value = dist.district;
                    option.textContent = `${dist.district} (${dist.location_count})`;
                    districtSelect.appendChild(option);
                });
                
                const typeSelect = document.getElementById('facility-filter');
                typeSelect.innerHTML = '<option value="">All Types</option>';
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.facility_type;
                    option.textContent = `${type.facility_type} (${type.count})`;
                    typeSelect.appendChild(option);
                });
                console.log('Filter options loaded');
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }
        
        function filterByAge(programs, ageRange) {
            if (!ageRange || ageRange === '') return programs;
            
            return programs.filter(prog => {
                let minAge = prog.age_min || prog.min_age;
                let maxAge = prog.age_max || prog.max_age;
                
                switch(ageRange) {
                    case 'young':
                        return (!maxAge || maxAge <= 12) || (!minAge || minAge < 12);
                    case 'teen':
                        return (!minAge || minAge <= 18) && (!maxAge || maxAge >= 13);
                    case 'adult':
                        return (!minAge || minAge <= 65) && (!maxAge || maxAge >= 19 || !maxAge);
                    case 'senior':
                        return !minAge || minAge >= 55;
                    default:
                        return true;
                }
            });
        }
        
        async function loadCentres() {
            showLoading(true);
            try {
                const params = new URLSearchParams();
                const activity = document.getElementById('activity-filter').value;
                const district = document.getElementById('district-filter').value;
                const weekday = document.getElementById('weekday-filter').value;
                const facilityType = document.getElementById('facility-filter').value;
                
                if (activity) params.append('activity', activity);
                if (district) params.append('district', district);
                if (weekday) params.append('weekday', weekday);
                if (facilityType) params.append('facility_type', facilityType);
                
                const url = `${API_URL}/api/centres/geojson?${params}`;
                console.log('Loading centres from:', url);
                const response = await fetch(url);
                const data = await response.json();
                console.log('Centres data:', data);
                
                if (map.getSource('centres')) {
                    map.getSource('centres').setData(data);
                } else {
                    map.addSource('centres', { type: 'geojson', data: data });
                    
                    map.addLayer({
                        id: 'centres-circle',
                        type: 'circle',
                        source: 'centres',
                        paint: {
                            'circle-radius': ['interpolate', ['linear'], ['get', 'total_programs'], 0, 8, 10, 12, 50, 16, 100, 20],
                            'circle-color': '#3b82f6',
                            'circle-opacity': 0.8,
                            'circle-stroke-width': 2,
                            'circle-stroke-color': '#ffffff'
                        }
                    });
                    
                    map.on('click', 'centres-circle', async (e) => {
                        const feature = e.features[0];
                        const centreId = feature.properties.id;
                        await showCentreDetails(centreId);
                    });
                    
                    map.on('mouseenter', 'centres-circle', () => { map.getCanvas().style.cursor = 'pointer'; });
                    map.on('mouseleave', 'centres-circle', () => { map.getCanvas().style.cursor = ''; });
                }
                
                const count = data.features ? data.features.length : 0;
                if (count > 0 && data.features) {
                    const bounds = new maplibregl.LngLatBounds();
                    data.features.forEach(feature => bounds.extend(feature.geometry.coordinates));
                    map.fitBounds(bounds, { padding: 100, maxZoom: 13 });
                }
                
                document.getElementById('status').innerHTML = `Found ${count} centre${count !== 1 ? 's' : ''}<br><small>Click markers for details</small>`;
            } catch (error) {
                console.error('Error loading centres:', error);
                document.getElementById('status').innerHTML = 'Error loading centres. Check console.';
            }
            showLoading(false);
        }
        
        async function showCentreDetails(centreId) {
            showLoading(true);
            currentCentreId = centreId;
            
            try {
                const [detailRes, programsRes, facilitiesRes] = await Promise.all([
                    fetch(`${API_URL}/api/centres/${centreId}`),
                    fetch(`${API_URL}/api/centres/${centreId}/programs`),
                    fetch(`${API_URL}/api/centres/${centreId}/facilities`)
                ]);
                
                const [detail, programs, facilities] = await Promise.all([
                    detailRes.json(),
                    programsRes.json(),
                    facilitiesRes.json()
                ]);
                
                allPrograms = programs;
                const ageFilter = document.getElementById('age-filter')?.value || '';
                const filteredDropin = filterByAge(programs.dropin, ageFilter);
                const filteredRegistered = filterByAge(programs.registered, ageFilter);
                
                document.getElementById('sidebarTitle').textContent = detail.name;
                document.getElementById('sidebarSubtitle').textContent = detail.facility_type || 'Recreation Centre';
                
                let html = '';
                
                html += '<div class="info-section">';
                html += '<h3>Location Information</h3>';
                if (detail.address) html += `<div class="info-row"><span class="info-label">Address:</span><span class="info-value">${detail.address}</span></div>`;
                if (detail.district) html += `<div class="info-row"><span class="info-label">District:</span><span class="info-value">${detail.district}</span></div>`;
                if (detail.intersection) html += `<div class="info-row"><span class="info-label">Intersection:</span><span class="info-value">${detail.intersection}</span></div>`;
                if (detail.ttc_information) html += `<div class="info-row"><span class="info-label">TTC:</span><span class="info-value">${detail.ttc_information}</span></div>`;
                if (detail.phone && detail.phone !== 'None') html += `<div class="info-row"><span class="info-label">Phone:</span><span class="info-value">${detail.phone}</span></div>`;
                html += '</div>';
                
                html += '<div class="info-section"><h3>Accessibility</h3>';
                html += `<div class="info-value">${detail.accessibility || 'Information not available'}</div></div>`;
                
                if (detail.amenities && detail.amenities !== 'None') {
                    html += '<div class="info-section"><h3>Amenities</h3>';
                    const amenitiesList = detail.amenities.split(',').map(a => a.trim());
                    amenitiesList.forEach(amenity => html += `<span class="badge badge-blue">${amenity}</span>`);
                    html += '</div>';
                }
                
                if (filteredDropin.length > 0) {
                    html += '<div class="info-section"><h3>Drop-in Programs</h3><div class="program-list" id="dropin-list">';
                    filteredDropin.forEach(prog => {
                        html += `<div class="program-item">`;
                        html += `<div class="program-title">${prog.course_title}</div>`;
                        html += '<div class="program-details">';
                        if (prog.day_of_week && prog.start_time) html += `${prog.day_of_week} ${prog.start_time.substring(0,5)} - ${prog.end_time.substring(0,5)}`;
                        if (prog.age_min || prog.age_max) {
                            let ageStr = '';
                            if (prog.age_min && prog.age_max) {
                                ageStr = `Ages: ${prog.age_min}-${prog.age_max}`;
                            } else if (prog.age_min) {
                                ageStr = `Ages: ${prog.age_min}+`;
                            } else if (prog.age_max) {
                                ageStr = `Ages: Under ${prog.age_max}`;
                            }
                            if (ageStr) html += ` | ${ageStr}`;
                        }
                        html += '</div></div>';
                    });
                    html += '</div></div>';
                }
                
                if (filteredRegistered.length > 0) {
                    html += '<div class="info-section"><h3>Registered Programs</h3><div class="program-list" id="registered-list">';
                    filteredRegistered.forEach(prog => {
                        html += `<div class="program-item">`;
                        html += `<div class="program-title">${prog.course_title}</div>`;
                        html += '<div class="program-details">';
                        if (prog.days_of_week) html += `${prog.days_of_week}`;
                        if (prog.program_category) html += ` | ${prog.program_category}`;
                        if (prog.min_age || prog.max_age) {
                            let ageStr = '';
                            if (prog.min_age && prog.max_age) {
                                ageStr = `Ages: ${prog.min_age}-${prog.max_age}`;
                            } else if (prog.min_age) {
                                ageStr = `Ages: ${prog.min_age}+`;
                            } else if (prog.max_age) {
                                ageStr = `Ages: Under ${prog.max_age}`;
                            }
                            if (ageStr) html += ` | ${ageStr}`;
                        }
                        html += '</div></div>';
                    });
                    html += '</div></div>';
                }
                
                if (filteredDropin.length === 0 && filteredRegistered.length === 0) {
                    html += '<div class="info-section"><div class="info-value">No programs match your age filter</div></div>';
                }
                
                if (facilities.length > 0) {
                    html += '<div class="info-section"><h3>Facilities</h3>';
                    const facilityTypes = {};
                    facilities.forEach(f => { facilityTypes[f.facility_type] = (facilityTypes[f.facility_type] || 0) + 1; });
                    Object.entries(facilityTypes).forEach(([type, count]) => html += `<span class="badge badge-blue">${type} (${count})</span>`);
                    html += '</div>';
                }
                
                if (detail.description && detail.description !== 'None') {
                    html += '<div class="info-section"><h3>Description</h3>';
                    html += `<div class="info-value">${detail.description}</div></div>`;
                }
                
                if (detail.url && detail.url !== 'None') {
                    html += `<a href="${detail.url}" target="_blank" class="external-link">View on Toronto.ca</a>`;
      
// === finish showCentreDetails: inject HTML and open the sidebar ===
                }

                // Inject into sidebar and open it
                const panel = document.getElementById('sidebarContent');
                panel.innerHTML = html;
                openSidebar();
            } catch (err) {
                console.error('Error loading centre details:', err);
            }
            showLoading(false);
        }

// ========== UI helpers & event handlers ==========
function showLoading(show) {
    const el = document.getElementById('loading');
    el.style.display = show ? 'block' : 'none';
}

function openSidebar() {
    document.getElementById('detailsSidebar').classList.add('open');
}
function closeSidebar() {
    document.getElementById('detailsSidebar').classList.remove('open');
}
window.closeSidebar = closeSidebar; // enable HTML onclick

function applyFilters() {
    loadCentres();
}
window.applyFilters = applyFilters;

function resetFilters() {
    ['activity-filter','district-filter','weekday-filter','age-filter','facility-filter']
      .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
      });
    loadCentres();
    if (currentCentreId) updateProgramsByAge();
}
window.resetFilters = resetFilters;

// Re-render program lists in the sidebar when age filter changes
function updateProgramsByAge() {
    if (!allPrograms) return;
    const age = document.getElementById('age-filter')?.value || '';

    const filteredDropin = filterByAge(allPrograms.dropin || [], age);
    const filteredRegistered = filterByAge(allPrograms.registered || [], age);

    const dropinContainer = document.getElementById('dropin-list');
    const regContainer = document.getElementById('registered-list');

    if (dropinContainer) {
        dropinContainer.innerHTML = filteredDropin.map(prog => {
            const time = (prog.day_of_week && prog.start_time)
                ? `${prog.day_of_week} ${prog.start_time.substring(0,5)} - ${prog.end_time.substring(0,5)}`
                : '';
            let ageStr = '';
            if (prog.age_min && prog.age_max) ageStr = ` | Ages: ${prog.age_min}-${prog.age_max}`;
            else if (prog.age_min)           ageStr = ` | Ages: ${prog.age_min}+`;
            else if (prog.age_max)           ageStr = ` | Ages: Under ${prog.age_max}`;
            return `
            <div class="program-item">
              <div class="program-title">${prog.course_title || ''}</div>
              <div class="program-details">${time}${ageStr}</div>
            </div>`;
        }).join('');
    }

    if (regContainer) {
        regContainer.innerHTML = filteredRegistered.map(prog => {
            const days = prog.days_of_week ? `${prog.days_of_week}` : '';
            const cat  = prog.program_category ? ` | ${prog.program_category}` : '';
            let ageStr = '';
            if (prog.min_age && prog.max_age) ageStr = ` | Ages: ${prog.min_age}-${prog.max_age}`;
            else if (prog.min_age)            ageStr = ` | Ages: ${prog.min_age}+`;
            else if (prog.max_age)            ageStr = ` | Ages: Under ${prog.max_age}`;
            return `
            <div class="program-item">
              <div class="program-title">${prog.course_title || ''}</div>
              <div class="program-details">${days}${cat}${ageStr}</div>
            </div>`;
        }).join('');
    }

    if ((filteredDropin.length === 0) && (filteredRegistered.length === 0)) {
        const panel = document.getElementById('sidebarContent');
        const notice = document.createElement('div');
        notice.className = 'info-section';
        notice.innerHTML = '<div class="info-value">No programs match your age filter</div>';
        panel.appendChild(notice);
    }
}

// live update when age changes
document.getElementById('age-filter')?.addEventListener('change', updateProgramsByAge);

// Legend toggles
function toggleLayer(name) {
    if (!map) return;
    if (name === 'centres') {
        const vis = map.getLayoutProperty('centres-circle', 'visibility') !== 'none' ? 'none' : 'visible';
        if (map.getLayer('centres-circle')) map.setLayoutProperty('centres-circle', 'visibility', vis);
    }
    if (name === 'wards') {
        const isVisible = map.getLayoutProperty('wards-outline', 'visibility') !== 'none';
        const vis = isVisible ? 'none' : 'visible';
        if (map.getLayer('wards-fill'))    map.setLayoutProperty('wards-fill', 'visibility', vis);
        if (map.getLayer('wards-outline')) map.setLayoutProperty('wards-outline', 'visibility', vis);
    }
}
window.toggleLayer = toggleLayer;

// Find Near Me (geolocate and fly)
let userMarker = null;
function findNearMe() {
    if (!navigator.geolocation) {
        document.getElementById('status').textContent = 'Geolocation is not supported by this browser.';
        return;
    }
    document.getElementById('status').textContent = 'Locating…';
    navigator.geolocation.getCurrentPosition(pos => {
        userLocation = [pos.coords.longitude, pos.coords.latitude];
        if (userMarker) userMarker.remove();
        userMarker = new maplibregl.Marker({ color: '#10b981' })
            .setLngLat(userLocation).addTo(map);
        map.flyTo({ center: userLocation, zoom: 13 });
        document.getElementById('status').textContent = 'Your location is shown (green marker).';
    }, err => {
        console.error(err);
        document.getElementById('status').textContent = 'Unable to retrieve your location.';
    }, { enableHighAccuracy: true, timeout: 10000 });
}
window.findNearMe = findNearMe;

// Resizable sidebar
function initSidebarResizer() {
    const sidebar = document.getElementById('detailsSidebar');
    const resizer = document.getElementById('sidebarResizer');
    if (!sidebar || !resizer) return;

    let resizing = false;

    const onMove = (e) => {
        if (!resizing) return;
        const pageX = e.touches ? e.touches[0].pageX : e.pageX;
        const newWidth = Math.min(Math.max(window.innerWidth - pageX, 320), 800);
        sidebar.style.width = `${newWidth}px`;
    };

    const stop = () => { resizing = false; document.body.style.userSelect = ''; };

    resizer.addEventListener('mousedown', () => { resizing = true; document.body.style.userSelect = 'none'; });
    resizer.addEventListener('touchstart', () => { resizing = true; document.body.style.userSelect = 'none'; });

    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove, { passive: false });

    window.addEventListener('mouseup', stop);
    window.addEventListener('mouseleave', stop);
    window.addEventListener('touchend', stop);
}
</script>
